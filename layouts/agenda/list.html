{{ define "main" }}

<style>
  /* jak wcze≈õniej ‚Äî styl kart sesji + layout ‚Äúwiersz tabeli‚Äù */
  .sessions-list .session-card{background:#1b2635;border-radius:.75rem;padding:1.25rem 1.5rem;height:100%;box-shadow:0 0 0 0 rgba(0,0,0,.2)}
  .sessions-list .session-title{font-weight:700}
  .sessions-list .session-speaker{font-weight:700}
  .sessions-list .badge{border:0;background:rgba(255,255,255,.12);color:#fff;margin-right:.35rem}
  .sessions-list .badge.level{background:linear-gradient(90deg,#6c7a89,#93a1ad)}
  .sessions-list .badge.level.l100{background:linear-gradient(90deg,#16a34a,#22c55e)}
  .sessions-list .badge.level.l200{background:linear-gradient(90deg,#2563eb,#60a5fa)}
  .sessions-list .badge.level.l300{background:linear-gradient(90deg,#6f42c1,#a78bfa)}
  .sessions-list .badge.level.l400{background:linear-gradient(90deg,#ef4444,#f97316)}
  .sessions-list .badge.format{background:linear-gradient(90deg,#ff9900,#6f42c1)}
  .sessions-list .badge.tag{background:rgba(255,255,255,.18)}
  .sessions-list .session-meta{color:rgba(255,255,255,.75)}
  .sessions-list a.card-link{text-decoration:none;color:inherit;display:block}
  .sessions-list a.card-link:hover .session-title{text-decoration:underline}
  .sessions-list .avatar{width:64px;height:64px;border-radius:9999px;background:#17202c;overflow:hidden;display:inline-block}
  .sessions-list .avatar img{width:100%;height:100%;object-fit:cover}
  .sessions-list .avatar-group{display:inline-flex;align-items:center}
  .sessions-list .avatar-sm{width:40px;height:40px;border-radius:9999px;overflow:hidden;background:#17202c;border:2px solid #1b2635}
  .sessions-list .avatar-stack>span{margin-left:-10px;position:relative}
  .sessions-list .avatar-initials{width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#9fb3c8;background:#17202c;border:2px solid #1b2635}

  .agenda-row{border-bottom:1px solid rgba(255,255,255,.08);padding:1rem 0}
  .agenda-left{min-width:220px}
  .agenda-slot{font-weight:700}
  .agenda-left .slot-meta{color:rgba(255,255,255,.75)}
</style>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 text-center mb-4">
      <h1 class="h2 m-0">{{ .Title }}</h1>
    </div>
  </div>

  {{- $slots := .Pages.ByTitle -}}
  {{- $allSessions := where site.RegularPages "Section" "sessions" -}}
  {{- /* je≈õli chcesz globalnie ukrywaƒá level dla Keynote/Organizational ‚Äî robimy to per kartƒô ni≈ºej */ -}}

  {{- range $slot := $slots -}}
    {{- $slotKey := $slot.File.ContentBaseName -}}
    {{- $slotSessions := where $allSessions ".Params.agenda" $slotKey -}}

    <div class="row agenda-row">
      <!-- lewa kolumna: slot -->
      <div class="col-12 col-md-3 agenda-left">
        <div class="agenda-slot">
          <a class="text-reset text-decoration-none" href="{{ $slot.RelPermalink }}">{{ $slot.Title }}</a>
        </div>
        {{ with $slot.Params.subtitle }}
          <div class="slot-meta">{{ . }}</div>
        {{ end }}
      </div>

      <!-- prawa kolumna: je≈õli sƒÖ sesje -> lista kart; je≈õli brak -> karta slotu (np. Lunch) -->
      <div class="col-12 col-md-9">
        {{- if gt (len $slotSessions) 0 -}}
          <div class="row g-3 sessions-list">
            {{- $slotSessions = sort (sort $slotSessions ".Params.room" "asc") ".Date" "asc" -}}
            {{- range $s := $slotSessions -}}
              {{- $cardTitle := default $s.Title $s.Params.summary -}}
              {{- $format := $s.Params.format -}}
              {{- $lvlStr := printf "%v" $s.Params.level -}}
              {{- $tags := $s.Params.tags -}}
              {{- $hideLevel := or (eq $format "Keynote") (eq $format "Organizational") -}}

              {{- $roomSlug := $s.Params.room -}}
              {{- $roomPage := cond (not $roomSlug) nil (site.GetPage (printf "rooms/%s" $roomSlug)) -}}

              {{- $speakerSlugs := $s.Params.speakers | default (slice) -}}
              {{- $speakerPages := slice -}}
              {{- $allSpeakers := where site.Pages "Section" "speakers" -}}
              {{- range $speakerSlugs }}
                {{- $slug := . -}}
                {{- $fromGetPage := site.GetPage (printf "speakers/%s" $slug) -}}
                {{- $fallback := index (where $allSpeakers ".File.TranslationBaseName" $slug) 0 -}}
                {{- $p := or $fromGetPage $fallback -}}
                {{- if $p }}{{- $speakerPages = $speakerPages | append $p -}}{{- end -}}
              {{- end -}}
              {{- $speakerNames := slice -}}
              {{- range $speakerPages }}{{- $speakerNames = $speakerNames | append .Title -}}{{- end -}}
              {{- $speakerNamesStr := delimit $speakerNames ", " -}}

              <div class="col-12">
                <a class="card-link" href="{{ $s.RelPermalink }}">
                  <div class="session-card">
                    <div class="row g-3 align-items-center">
                      <div class="col-12 col-md-9">
                        <div class="session-title h5 m-0">{{ $cardTitle }}</div>
                        <div class="mt-2">
                          {{- with $format -}}<span class="badge format">{{ . }}</span>{{- end -}}
                          {{- if and $lvlStr (not $hideLevel) -}}
                            <span class="badge level {{ cond (eq $lvlStr "100") "l100" (cond (eq $lvlStr "200") "l200" (cond (eq $lvlStr "300") "l300" (cond (eq $lvlStr "400") "l400" ""))) }}">
                              Level {{ $lvlStr }}
                            </span>
                          {{- end -}}
                          {{- range $tags }}<span class="badge tag">{{ . }}</span>{{- end }}
                        </div>
                        {{- if $s.Params.summary -}}
                          <div class="mt-3 session-meta">{{ $s.Params.summary }}</div>
                        {{- else if $s.Content -}}
                          <div class="mt-3 session-meta">{{ $s.Content | plainify | truncate 360 }}</div>
                        {{- end -}}
                      </div>
                      <div class="col-12 col-md-3 text-md-end">
                        <div class="avatar-group avatar-stack mb-2">
                          {{- $maxAv := 3 -}}
                          {{- $count := len $speakerPages -}}
                          {{- range $i, $sp := first $maxAv $speakerPages }}
                            {{- $photo := or ($sp.Resources.GetMatch "img/photo*") ($sp.Resources.GetMatch "img/*") -}}
                            <span title="{{ $sp.Title }}">
                              {{- if $photo -}}
                                <img class="avatar-sm" src="{{ $photo.RelPermalink }}" alt="{{ $sp.Title }}">
                              {{- else -}}
                                <span class="avatar-initials">{{ (substr $sp.Title 0 1) | upper }}</span>
                              {{- end -}}
                            </span>
                          {{- end -}}
                          {{- if gt $count $maxAv -}}
                            <span><span class="avatar-initials">+{{ sub $count $maxAv }}</span></span>
                          {{- end -}}
                        </div>
                        {{- if $speakerNamesStr -}}<div class="session-speaker">{{ $speakerNamesStr }}</div>{{- end -}}
                      </div>
                    </div>

                    <div class="row mt-3">
                      <div class="col session-meta">
                        {{- with $s.Date }}üïí {{ . | time.Format "2006-01-02 15:04" }}{{- end -}}
                        {{- with $roomPage }} &nbsp;‚Ä¢&nbsp; üìç {{ .Title }}{{- end -}}
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            {{- end -}}
          </div>
        {{- else -}}
          <!-- Slot bez sesji: poka≈º kartƒô slotu (np. Lunch) -->
          <div class="sessions-list">
            <div class="session-card">
              <div class="row g-3 align-items-center">
                <div class="col-12">
                  {{- if $slot.Params.summary -}}
                  <div class="session-title h5 m-0">{{ $slot.Params.summary }}</div>
                  {{- else -}}
                  <div class="session-title h5 m-0">{{ $slot.Title }}</div>
                  {{- end -}}
                  <div class="mt-2">
                    {{- with $slot.Params.format -}}<span class="badge format">{{ . }}</span>{{- end -}}
                    {{- /* level celowo pomijamy dla ‚Äúorganizacyjnych‚Äù */ -}}
                    {{- range $slot.Params.tags }}<span class="badge tag">{{ . }}</span>{{- end }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {{- end -}}
      </div>
    </div>
  {{- end -}}
</div>

{{ end }}