{{ define "main" }}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 text-center mb-4">
      <h1 class="h2 m-0">{{ .Title }}</h1>
    </div>
  </div>
<style>
  .sessions-list .session-card{background:#1b2635;border-radius:.75rem;padding:1.25rem 1.5rem;height:100%;box-shadow:0 0 0 0 rgba(0,0,0,.2)}
  .sessions-list .session-title{font-weight:700}
  .sessions-list .session-speaker{font-weight:700}
  .sessions-list .badge{border:0;background:rgba(255,255,255,.12);color:#fff;margin-right:.35rem}
  .sessions-list .badge.level{background:linear-gradient(90deg,#6c7a89,#93a1ad)}
  .sessions-list .badge.level.l100{background:linear-gradient(90deg,#16a34a,#22c55e)}
  .sessions-list .badge.level.l200{background:linear-gradient(90deg,#2563eb,#60a5fa)}
  .sessions-list .badge.level.l300{background:linear-gradient(90deg,#6f42c1,#a78bfa)}
  .sessions-list .badge.level.l400{background:linear-gradient(90deg,#ef4444,#f97316)}
  .sessions-list .badge.format{background:linear-gradient(90deg,#ff9900,#6f42c1)}
  .sessions-list .badge.tag{background:rgba(255,255,255,.18)}
  .sessions-list .session-meta{color:rgba(255,255,255,.75)}
  .sessions-list a.card-link{text-decoration:none;color:inherit;display:block}
  .sessions-list a.card-link:hover .session-title{text-decoration:underline}
  .sessions-list .avatar{width:64px;height:64px;border-radius:9999px;background:#17202c;overflow:hidden;display:inline-block}
  .sessions-list .avatar img{width:100%;height:100%;object-fit:cover}

  /* Multi-speaker avatars */
  .sessions-list .avatar-group{display:inline-flex;align-items:center}
  .sessions-list .avatar-sm{width:40px;height:40px;border-radius:9999px;overflow:hidden;background:#17202c;border:2px solid #1b2635}
  .sessions-list .avatar-stack>span{margin-left:-10px;position:relative}
  .sessions-list .avatar-initials{width:40px;height:40px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#9fb3c8;background:#17202c;border:2px solid #1b2635}
</style>

<div class="row g-3 sessions-list">
  {{- /* 1) We≈∫ sessions i odfiltruj Keynote/Organizational */ -}}
  {{- $items := where .Pages ".Params.format" "not in" (slice "Keynote" "Organizational") -}}

  {{- /* 2) Sortowanie ‚Äì zmie≈Ñ na ".Params.agenda" je≈õli wolisz rƒôczne sloty */ -}}
  {{- $items = sort $items ".Date" "asc" -}}
  {{- /* np.: $items = sort $items ".Params.agenda" "asc" */ -}}

  {{- /* 3) Przeleƒá po sesjach */ -}}
  {{- range $s := $items -}}
    {{- /* Tytu≈Ç karty: preferuj summary jak w wersji "speakers" */ -}}
    {{- $cardTitle := default $s.Title $s.Params.summary -}}

    {{- /* Badges */ -}}
    {{- $format := $s.Params.format -}}
    {{- $lvlStr := printf "%v" $s.Params.level -}}
    {{- $tags := $s.Params.tags -}}

    {{- /* Resolve speakers po slugach (dzia≈Ça dla _index/index/slug.md) */ -}}
    {{- $speakerSlugs := $s.Params.speakers | default (slice) -}}
    {{- $speakerPages := slice -}}
    {{- $allSpeakers := where site.Pages "Section" "speakers" -}}
    {{- range $speakerSlugs }}
      {{- $slug := . -}}
      {{- $fromGetPage := site.GetPage (printf "speakers/%s" $slug) -}}
      {{- $fallback := index (where $allSpeakers ".File.TranslationBaseName" $slug) 0 -}}
      {{- $p := or $fromGetPage $fallback -}}
      {{- if $p }}{{- $speakerPages = $speakerPages | append $p -}}{{- end -}}
    {{- end -}}

    {{- /* Nazwy i headline */ -}}
    {{- $speakerNames := slice -}}
    {{- range $speakerPages }}{{- $speakerNames = $speakerNames | append .Title -}}{{- end -}}
    {{- $speakerNamesStr := delimit $speakerNames ", " -}}
    {{- $primary := cond (gt (len $speakerPages) 0) (index $speakerPages 0) nil -}}
    {{- $headline := cond (not $primary) "" $primary.Params.headline -}}

    <div class="col-12">
      <a class="card-link" href="{{ $s.RelPermalink }}">
        <div class="session-card">
          <div class="row g-3 align-items-center">
            <div class="col-12 col-md-9">
              <div class="session-title h5 m-0">{{ $cardTitle }}</div>
              <div class="mt-2">
                {{- with $format -}}<span class="badge format">{{ . }}</span>{{- end -}}
                {{- if $lvlStr }}
                  <span class="badge level {{ cond (eq $lvlStr "100") "l100" (cond (eq $lvlStr "200") "l200" (cond (eq $lvlStr "300") "l300" (cond (eq $lvlStr "400") "l400" ""))) }}">
                    Level {{ $lvlStr }}
                  </span>
                {{- end -}}
                {{- range $tags }}<span class="badge tag">{{ . }}</span>{{- end }}
              </div>
              {{- if $s.Params.summary -}}
                <div class="mt-3 session-meta">{{ $s.Params.summary }}</div>
              {{- else if $s.Content -}}
                <div class="mt-3 session-meta">{{ $s.Content | plainify | truncate 360 }}</div>
              {{- end -}}
            </div>

            <div class="col-12 col-md-3 text-md-end">
            <div class="avatar-group avatar-stack mb-2">
                {{- $maxAv := 3 -}}
                {{- $count := len $speakerPages -}}
                {{- range $i, $sp := first $maxAv $speakerPages }}
                {{- $photo := or ($sp.Resources.GetMatch "img/photo*") ($sp.Resources.GetMatch "img/*") -}}
                <span title="{{ $sp.Title }}">
                    {{- if $photo -}}
                    <img class="avatar-sm" src="{{ $photo.RelPermalink }}" alt="{{ $sp.Title }}">
                    {{- else -}}
                    <span class="avatar-initials">{{ (substr $sp.Title 0 1) | upper }}</span>
                    {{- end -}}
                </span>
                {{- end -}}
                {{- if gt $count $maxAv -}}
                <span><span class="avatar-initials">+{{ sub $count $maxAv }}</span></span>
                {{- end -}}
            </div>

            {{- range $sp := $speakerPages }}
                <div class="session-speaker">{{ $sp.Title }}</div>
                {{- with $sp.Params.headline }}
                <div class="session-meta">{{ . }}</div>
                {{- end -}}
            {{- end -}}
            </div>
          </div>

          {{- /* Dodatkowy wiersz z metadanymi czasu/sali/itp. */ -}}
          <div class="row mt-3">
            <div class="col session-meta">
              {{- with $s.Date }}üïí {{ . | time.Format "2006-01-02 15:04" }}{{- end -}}
              {{- with $s.Params.room }}
                {{- $roomPage := site.GetPage (printf "rooms/%s" .) -}}
                &nbsp;‚Ä¢&nbsp; üìç {{ if $roomPage }}{{ $roomPage.Title }}{{ else }}{{ . }}{{ end }}
              {{- end -}}
            </div>
          </div>
        </div>
      </a>
    </div>
  {{- end -}}
</div>
{{ end }}